# フェッチ頻度の分析と改善案

## 現在の実装

### キャッシュ設定

```typescript
const CACHE_DURATION = 5 * 60 * 1000; // 5分 = 300秒
```

### フェッチタイミング

1. 初回アクセス → Notion API呼び出し
2. 5分以内 → キャッシュから返却
3. 5分経過後 → Notion API呼び出し
4. サーバー再起動 → キャッシュクリア

## 問題点

### 1. 頻度の問題

- **Notion APIレート制限**: 3リクエスト/秒
- **現在の実装**: アクセスがあるたびに5分間隔でAPI呼び出し
- **リスク**: 多数のユーザーアクセス時にレート制限に引っかかる可能性

### 2. リアルタイム性の問題

- **更新反映**: 最大5分の遅延
- **キャッシュクリア**: 手動操作が必要

### 3. サーバーサイドキャッシュの問題

- **Vercel等**: サーバーレス環境ではメモリキャッシュが無効
- **スケーリング**: 複数インスタンス間でキャッシュが共有されない

## 改善案

### Option 1: ISR (Incremental Static Regeneration)

```typescript
// revalidate を設定
export const revalidate = 300; // 5分間隔で再生成
```

- **メリット**: 静的生成＋定期更新
- **デメリット**: Next.js依存

### Option 2: Webhookベース更新

```typescript
// Notion側で変更時にWebhookを送信
// /api/awards/webhook で受信してキャッシュクリア
```

- **メリット**: リアルタイム更新
- **デメリット**: Notion Webhook設定が必要

### Option 3: Redis/外部キャッシュ

```typescript
// Redisやメモリストアを使用
const redis = new Redis(process.env.REDIS_URL);
```

- **メリット**: 複数インスタンス間で共有
- **デメリット**: インフラコストがかかる

### Option 4: 段階的キャッシュ

```typescript
// 短期キャッシュ + 長期キャッシュ
const SHORT_CACHE = 1 * 60 * 1000; // 1分
const LONG_CACHE = 60 * 60 * 1000; // 1時間
```

- **メリット**: フレキシブル
- **デメリット**: 複雑性増加

## 推奨設定

### 開発環境

- キャッシュ時間: 30秒〜1分
- 手動リフレッシュ機能: 有効

### 本番環境

- キャッシュ時間: 15分〜30分
- ISRまたはWebhook使用
- エラー時フォールバック

## 実装優先度

1. **即座実装**: キャッシュ時間の調整
2. **短期**: ISR対応
3. **中期**: Webhook連携
4. **長期**: 外部キャッシュストア
